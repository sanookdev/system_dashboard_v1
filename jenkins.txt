pipeline {
    agent any 

    environment {
        // --- ตั้งค่า Configuration ตรงนี้ ---
        PROJECT_ROOT = "C:\Users\Administrator\Desktop\services\intra_dashboard_prod\system_dashboard_v1"  // แก้ไขเป็น Path จริงของโปรเจกต์
        BACKUP_DIR = "C:\Users\Administrator\Desktop\services\intra_dashboard_prod\system_dashboard_v1\backup" // ที่เก็บ Backup ชั่วคราว
        PM2_APP_NAME = "INTRA_DASHBOARD_PROD"           // ชื่อ App ใน PM2 (เช็คด้วย pm2 list)
        APP_PORT = "5177"                         // Port ที่รันอยู่
        CHECK_URL = "http://127.0.0.1:5177"       // URL สำหรับเช็คว่า App รันขึ้นไหม (ใช้ Localhost ในการเช็ค)
    }

    stages {
        stage('Checkout SCM') {
            steps {
                // ขั้นตอนที่ 1 & 2: Jenkins จะจัดการเรื่อง git pull ให้อัตโนมัติถ้าตั้งค่าใน job
                checkout scm
            }
        }

        stage('Backup Current Version') {
            steps {
                script {
                    echo "--- Creating Backup of current stable version ---"
                    powershell """
                        if (Test-Path -Path '${env.PROJECT_ROOT}') {
                            if (Test-Path -Path '${env.BACKUP_DIR}') {
                                Remove-Item -Path '${env.BACKUP_DIR}' -Recurse -Force
                            }
                            New-Item -ItemType Directory -Force -Path '${env.BACKUP_DIR}' | Out-Null
                            Copy-Item -Path '${env.PROJECT_ROOT}\\*' -Destination '${env.BACKUP_DIR}' -Recurse -Force
                        } else {
                            Write-Host "First Deployment or Path invalid, skipping backup."
                        }
                    """
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "--- Installing Backend Dependencies ---"
                dir("${env.PROJECT_ROOT}/Backend") {
                    powershell 'npm install'
                }
                
                echo "--- Installing Frontend Dependencies ---"
                dir("${env.PROJECT_ROOT}/Frontend") {
                    powershell 'npm install'
                }
            }
        }

        stage('Build Frontend') {
            // ขั้นตอนที่ 3: Build frontend
            steps {
                echo "--- Building Vue.js ---"
                dir("${env.PROJECT_ROOT}/Frontend") {
                    powershell 'npm run build'
                }
            }
        }

        stage('Deploy Frontend to Backend') {
            steps {
                echo "--- Moving Dist to Backend/www ---"
                powershell """
                    $source = "${env.PROJECT_ROOT}\\Frontend\\dist\\*"
                    $dest = "${env.PROJECT_ROOT}\\Backend\\www"
                    
                    if (!(Test-Path -Path $dest)) {
                        New-Item -ItemType Directory -Force -Path $dest | Out-Null
                    }
                    
                    Copy-Item -Path $source -Destination $dest -Recurse -Force
                """
            }
        }

        stage('Restart PM2 & Health Check') {
            // ขั้นตอนที่ 4: Restart และเช็ค Error
            steps {
                script {
                    try {
                        echo "--- Restarting PM2 ---"
                        // ใช้ command นี้เพื่อให้แน่ใจว่า update env variables ด้วย
                        powershell "pm2 restart ${env.PM2_APP_NAME} --update-env"
                        
                        // รอสักครู่ให้ Server boot เสร็จ (Express อาจใช้เวลา start)
                        sleep 10 

                        echo "--- Checking Application Status ---"
                        powershell """
                            try {
                                $response = Invoke-WebRequest -Uri '${env.CHECK_URL}' -Method Get -UseBasicParsing
                                if ($response.StatusCode -ne 200) {
                                    Write-Error "Server returned status code $($response.StatusCode)"
                                } else {
                                    Write-Host "Success: Server is running at ${env.CHECK_URL}"
                                }
                            } catch {
                                Write-Error "Failed to connect to ${env.CHECK_URL}. Service might be down."
                            }
                        """
                    } catch (err) {
                        echo "Deployment Failed! Initiating Rollback..."
                        throw err // ส่งต่อ Error ไปที่ post failure
                    }
                }
            }
        }
    }

    post {
        failure {
            // ขั้นตอน Rollback: ทำงานเมื่อเกิด Error ใน Stage ใดๆ
            script {
                echo "!!! DEPLOYMENT FAILED - ROLLING BACK !!!"
                
                // 1. ดึง Logs ล่าสุดมาแสดงใน Jenkins Console
                echo "--- Recent PM2 Logs ---"
                powershell "pm2 logs ${env.PM2_APP_NAME} --lines 50 --nostream"

                // 2. คืนค่าไฟล์จาก Backup
                echo "--- Restoring files from Backup ---"
                powershell """
                    if (Test-Path -Path '${env.BACKUP_DIR}') {
                        Copy-Item -Path '${env.BACKUP_DIR}\\*' -Destination '${env.PROJECT_ROOT}' -Recurse -Force
                        Write-Host "Files restored."
                    } else {
                        Write-Error "No backup found! Cannot rollback."
                    }
                """

                // 3. Restart PM2 อีกครั้งเพื่อให้กลับไปใช้ code เก่า
                echo "--- Restarting PM2 (Reverting) ---"
                powershell "pm2 restart ${env.PM2_APP_NAME}"
                
                echo "Rollback Complete. The system is back to the previous version."
            }
        }
        success {
            echo "Deployment Successful!"
        }
    }
}